input AMPLIFY {
  globalAuthRule: AuthRule = { allow: public }
}

enum InterestCalculationMethod {
  SIMPLE
  COMPOUND
  FLAT
}

enum Frequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  SEMIANNUALLY
  ANNUALLY
}

enum LoanStatus {
  DRAFT
  APPROVED
  ACTIVE
  CLOSED
  WRITTEN_OFF
  VOIDED
}

enum LoanApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum LoanDraftStatus {
  DRAFT
  SENT_FOR_APPROVAL
  APPROVED
  REJECTED
  CONVERTED
  ARCHIVED
}

enum LoanDraftSource {
  BLANK
  TEMPLATE
  COPY
}

enum InstallmentStatus {
  PENDING
  PARTIALLY_PAID
  PAID
  OVERDUE
}

enum DisbursementStatus {
  PENDING
  COMPLETED
  FAILED
}

enum PaymentStatus {
  PENDING
  COMPLETED
  REVERSED
  FAILED
}

enum LoanEventType {
  CREATED
  APPROVED
  DISBURSED
  PAYMENT_POSTED
  PAYMENT_REVERSED
  STATUS_CHANGED
  OTHER
}

enum ApprovalType {
  LOAN
  EXPENSE
  APPLICATION
  CREDIT_SCORE
  MONEY_TRANSACTION
  PAYMENT
}

type Institution @model {
  id: ID!
  name: String
  currencyCode: String
  subscriptionTier: String
  subscriptionStatus: String
  trialEndDate: AWSDate
  nextBillingDate: AWSDate
  stripeCustomerID: String
  stripeSubscriptionID: String

  # --- Geo / Regulatory settings ---
  defaultDateFormat: String
  defaultCurrencyFormat: String
  defaultLanguage: String
  regulatoryRegion: String

  # --- Tier‑based limits ---
  maxUsers: Int
  maxBranches: Int
  maxStaffPerBranch: Int

  # --- Feature flags ---
  saccoFeaturesEnabled: Boolean!
  staffManagementEnabled: Boolean!
  payrollEnabled: Boolean!
  collectionsModuleEnabled: Boolean!
  customWorkflowsEnabled: Boolean!
  advancedReportingEnabled: Boolean!

  # --- Integration settings ---
  apiIntegrationSettings: AWSJSON

  # --- Relationships (⇢ hasMany) ---
  users: [User] @hasMany
  branches: [Branch] @hasMany
  loanProducts: [LoanProduct] @hasMany
  customFormFields: [CustomFormField] @hasMany

  # --- LoanFeesConfig relationship ---
  loanFeesConfigs: [LoanFeesConfig] @hasMany

  accounts: [Account] @hasMany

  status: String
  savingsProducts: [SavingsProduct] @hasMany
  chartOfAccounts: [ChartOfAccounts] @hasMany
  dividendDeclarations: [DividendDeclaration] @hasMany
}

type Branch @model {
  id: ID!
  name: String
  branchCode: String
  address: String
  status: String

  # --- Relationships ---
  institution: Institution @belongsTo
  users: [User] @hasMany
  borrowers: [Borrower] @hasMany
  employees: [Employee] @hasMany
  accounts: [Account] @manyToMany(relationName: "AccountBranch")
  documents: [Document] @hasMany
  loanProducts: [LoanProduct] @manyToMany(relationName: "BranchLoanProduct")

  payrolls: [Payroll] @hasMany
  financialReports: [FinancialReport] @hasMany
  customFormFields: [CustomFormField] @hasMany
  loans: [Loan] @hasMany

  # --- LoanFeesConfig relationship ---
  loanFeesConfigs: [LoanFeesConfig]
    @manyToMany(relationName: "BranchLoanFeesConfig")
  groups: [Group] @hasMany
}

type User @model {
  id: ID!
  firstName: String
  lastName: String
  middleName: String
  dateOfBirth: String
  phoneNumber1: String
  phoneNumber2: String
  email: String
  addressLine1: String
  addressLine2: String
  city: String
  stateProvince: String
  postalCode: String
  nationalID: String
  passportNumber: String
  nationality: String
  status: String
  userType: String
  userPermissions: AWSJSON
  description: String
  customFieldsData: AWSJSON
  userDocuments: AWSJSON
  institution: Institution @belongsTo
  branch: Branch @belongsTo
  userNotifications: [UserNotification] @hasMany
  sentMessages: [Message] @hasMany
  receivedMessages: [Message] @hasMany
  sentNotifications: [Notification] @hasMany
  receivedNotifications: [Notification] @hasMany
}

type Employee @model {
  id: ID!
  firstName: String
  lastName: String
  middleName: String
  dateOfBirth: String
  phoneNumber1: String
  phoneNumber2: String
  email: String
  title: String
  addressLine1: String
  addressLine2: String
  city: String
  stateProvince: String
  postalCode: String
  nextOfKinName: String
  nextOfKinPhoneNumber: String
  nextOfKinEmail: String
  nextOfKinRelationship: String
  nextOfKinAddress: String
  nationalID: String
  passportNumber: String
  nationality: String
  status: String
  employmentType: String
  employmentStatus: String
  employmentStartDate: AWSDate
  employmentEndDate: AWSDate
  employmentPosition: String
  employmentDepartment: String
  employmentGrade: String
  employmentLocation: String
  grossSalary: Float
  bankAccountNumber: String
  bankName: String
  bankBranchCode: String
  socialSecurityNumber: String
  taxIdentificationNumber: String
  taxExemptStatus: String
  customFieldsData: AWSJSON
  branch: Branch @belongsTo
  relatedUserID: ID @index(name: "byRelatedUserID")
  relatedBorrowerID: ID @index(name: "byRelatedBorrowerID")
  payroll: [Payroll] @manyToMany(relationName: "PayrollEmployee")
  borrowers: [Borrower] @manyToMany(relationName: "BorrowerLoanOfficer")

  # Supervisor relationship
  supervisorID: ID @index(name: "bySupervisorID")
  supervisor: Employee @belongsTo(fields: ["supervisorID"])
  subordinates: [Employee] @hasMany

  # Indexed fields
  creditScore: [CreditScore] @hasMany
  applications: [Application] @hasMany
  documents: [Document] @hasMany
  expenses: [Expense] @hasMany
  payments: [Payment] @hasMany
  loans: [Loan] @hasMany
  moneyTransactions: [MoneyTransaction] @hasMany
  accounts: [Account] @hasMany
  postedJournalEntries: [JournalEntry] @hasMany

  # Savings Actions
  initiatedSavingsTransactions: [SavingsTransaction] @hasMany
  # Collections & Recovery
  assignedCollectionCases: [CollectionCase] @hasMany
  approvals: [Approval] @hasMany
}

type Borrower @model {
  id: ID!
  firstname: String
  othername: String
  businessName: String
  typeOfBusiness: String
  uniqueIdNumber: String
  phoneNumber: String
  otherPhoneNumber: String
  email: String
  gender: String
  dateOfBirth: String
  nationality: String
  nationalIdPicture: String
  passportPicture: String
  address: String
  points: Float
  borrowerOpeningBalance: Float
  borrowerClosingBalance: Float
  borrowerInterestRate: Float
  city: String
  state: String
  title: String
  zipcode: String
  employmentStatus: String
  employerName: String
  creditScore: String
  additionalNote1: String
  additionalNote2: String
  borrowerDocuments: AWSJSON
  customFieldsData: AWSJSON
  status: String
  branch: Branch @belongsTo
  loans: [Loan] @hasMany
  guarantors: [Guarantor] @hasMany
  securities: [Security] @hasMany
  applications: [Application] @hasMany
  contracts: [Contract] @hasMany
  documents: [Document] @manyToMany(relationName: "BorrowerDocument")
  employees: [Employee] @manyToMany(relationName: "BorrowerLoanOfficer")
  collaterals: [Collateral] @hasMany

  # Indexed fields
  creditScores: [CreditScore] @hasMany

  # --- Group Lending (Microfinance) ---
  # Only define this ONCE
  groupID: ID @index(name: "byGroup")
  group: Group @belongsTo(fields: ["groupID"])

  # Add MemberType
  memberType: String # "Individual", "GroupMember", "Corporate"
  # --- Member Assets (SACCO) ---
  savingsAccounts: [SavingsAccount] @hasMany
  shareAccount: ShareAccount @hasOne

  # --- Governance ---
}

type Guarantor @model {
  id: ID!
  name: String
  relationship: String
  phoneNumber: String
  email: String
  address: String
  customFieldsData: AWSJSON
  status: String
  borrower: Borrower @belongsTo
  loans: [Loan] @manyToMany(relationName: "LoanGuarantor")
  applications: [Application] @manyToMany(relationName: "ApplicationGuarantor")
  isExistingMember: Boolean
  memberID: ID # Link to Borrower table if they are a member
  lockedSavingsAmount: Float # If using their savings as collateral
}

type Security @model {
  id: ID!
  name: String
  type: String
  description: String
  value: Float
  status: String
  borrower: Borrower @belongsTo
}

type UserNotification @model {
  id: ID!
  eventType: String
  name: String
  description: String
  reference: String
  message: String
  status: String
  user: User @belongsTo
}

type LoanProduct @model {
  id: ID!
  name: String
  description: String

  # Principal settings
  principalAmountMin: Float
  principalAmountMax: Float
  principalAmountDefault: Float

  # Interest settings
  interestRateMin: Float
  interestRateMax: Float
  interestRateDefault: Float
  interestCalculationMethod: String
  interestType: String
  interestPeriod: String

  # Duration settings
  termDurationMin: Int
  termDurationMax: Int
  termDurationDefault: Int
  durationPeriod: String

  # Repayment settings
  repaymentFrequency: String
  repaymentOrder: AWSJSON

  # Maturity settings
  extendLoanAfterMaturity: Boolean
  interestTypeMaturity: String
  calculateInterestOn: String
  loanInterestRateAfterMaturity: Float
  recurringPeriodAfterMaturityUnit: String
  status: String

  # Relationships
  institution: Institution @belongsTo
  branches: [Branch] @manyToMany(relationName: "BranchLoanProduct")
  loanFees: [LoanFees] @manyToMany(relationName: "LoanProductLoanFees")
  loanFeesConfigs: [LoanFeesConfig]
    @manyToMany(relationName: "LoanProductLoanFeesConfig")
  loanPenalties: [Penalty] @manyToMany(relationName: "LoanProductPenalty")
  applications: [Application] @hasMany
  loans: [Loan] @hasMany
}

type CreditScore @model {
  id: ID!
  name: String
  description: String
  score: Float
  scoreDate: AWSDate
  scoreSource: String
  scoreStatus: String
  status: String
  borrowerID: ID @index(name: "byBorrowerID")
  borrower: Borrower @belongsTo(fields: ["borrowerID"])
  createdByEmployeeID: ID @index(name: "byCreatedByEmployeeID")
  createdByEmployee: Employee @belongsTo(fields: ["createdByEmployeeID"])
}

type Document @model {
  id: ID!
  documentType: String
  documentName: String
  documentDescription: String
  serialNumber: String
  documentDate: AWSDate
  s3Key: String
  fileName: String
  contentType: String
  status: String
  branch: Branch @belongsTo
  borrowers: [Borrower] @manyToMany(relationName: "BorrowerDocument")
  loans: [Loan] @manyToMany(relationName: "LoanDocument")
  applications: [Application] @manyToMany(relationName: "ApplicationDocument")
  contracts: [Contract] @manyToMany(relationName: "ContractDocument")
  expenses: [Expense] @manyToMany(relationName: "ExpenseDocument")
  payments: [Payment] @manyToMany(relationName: "PaymentDocument")
  moneyTransactions: [MoneyTransaction]
    @manyToMany(relationName: "MoneyTransactionDocument")
  createdByEmployeeID: ID @index(name: "byCreatedByEmployeeID")
  createdByEmployee: Employee @belongsTo(fields: ["createdByEmployeeID"])
}

type Contract @model {
  id: ID!
  contractNumber: String
  contractType: String
  contractDate: AWSDate
  contractStatus: String
  contractRecord: AWSJSON
  status: String
  borrower: Borrower @belongsTo
  applications: [Application] @manyToMany(relationName: "ApplicationContract")
  collaterals: [Collateral] @manyToMany(relationName: "CollateralContract")
  documents: [Document] @manyToMany(relationName: "ContractDocument")
  loans: [Loan] @manyToMany(relationName: "LoanContract")
}

type Application @model {
  id: ID!
  name: String
  description: String
  applicationNumber: String
  requestedPrincipalAmount: Float
  requestedTermMonths: Int
  requestedFrequency: Frequency
  applicationDate: AWSDate
  status: String
  applicationRecord: AWSJSON
  borrower: Borrower @belongsTo
  guarantors: [Guarantor] @manyToMany(relationName: "ApplicationGuarantor")
  collateral: [Collateral] @manyToMany(relationName: "ApplicationCollateral")
  contracts: [Contract] @manyToMany(relationName: "ApplicationContract")
  expenses: [Expense] @manyToMany(relationName: "ApplicationExpense")
  loans: [Loan] @manyToMany(relationName: "LoanApplication")
  documents: [Document] @manyToMany(relationName: "ApplicationDocument")
  loanProductID: ID @index(name: "byLoanProductID")
  loanProduct: LoanProduct @belongsTo(fields: ["loanProductID"])
  createdByEmployeeID: ID @index(name: "byCreatedByEmployeeID")
  createdByEmployee: Employee @belongsTo(fields: ["createdByEmployeeID"])
  customFieldsData: AWSJSON
}

type Collateral @model {
  id: ID!
  name: String
  type: String
  description: String
  location: String
  value: Float
  serialNumber: String
  registrationNumber: String
  insuranceDetails: String
  insuranceExpiryDate: AWSDate
  insuranceCompany: String
  storedAt: String
  customFieldsData: AWSJSON
  status: String
  borrower: Borrower @belongsTo
  loans: [Loan] @manyToMany(relationName: "LoanCollateral")
  applications: [Application] @manyToMany(relationName: "ApplicationCollateral")
  contracts: [Contract] @manyToMany(relationName: "CollateralContract")
}

type LoanDraft @model {
  id: ID!
  status: LoanDraftStatus!
  source: LoanDraftSource
  draftNumber: String

  institutionID: ID @index(name: "byInstitution", sortKeyFields: ["updatedAt"])
  branchID: ID @index(name: "byBranch", sortKeyFields: ["updatedAt"])

  borrowerID: ID @index(name: "byBorrower", sortKeyFields: ["updatedAt"])
  loanProductID: ID @index(name: "byLoanProduct", sortKeyFields: ["updatedAt"])
  createdByEmployeeID: ID
    @index(name: "byCreatedByEmployee", sortKeyFields: ["updatedAt"])
  assignedToEmployeeID: ID
    @index(name: "byAssignedToEmployee", sortKeyFields: ["updatedAt"])

  submittedAt: AWSDateTime
  approvedAt: AWSDateTime
  rejectedAt: AWSDateTime
  rejectionReason: String
  convertedAt: AWSDateTime

  draftRecord: AWSJSON!
  termsSnapshot: AWSJSON
  schedulePreview: AWSJSON
  scheduleHash: String

  editVersion: Int!
  lastEditedByEmployeeID: ID
  lastEditedAt: AWSDateTime

  principal: Float
  interestRate: Float
  interestCalculationMethod: InterestCalculationMethod
  startDate: AWSDate
  maturityDate: AWSDate
  loanCurrency: String

  createdAt: AWSDateTime
  updatedAt: AWSDateTime

  loans: [Loan] @hasMany
}

type LoanDraftEvent @model {
  id: ID!
  loanDraftID: ID! @index(name: "byLoanDraft", sortKeyFields: ["eventAt"])
  eventAt: AWSDateTime!
  eventType: String!
  actorEmployeeID: ID
  summary: String
  payload: AWSJSON
}

type Loan @model {
  id: ID!
  loanNumber: String @index(name: "byLoanNumber")
  approvalStatus: String
  approvalStatusEnum: LoanApprovalStatus
  approvedDate: AWSDate
  principal: Float
  fees: Float
  interestRate: Float
  startDate: AWSDate
  maturityDate: AWSDate
  stopDate: AWSDate
  extensionPeriod: Float
  duration: Float
  durationInterval: String
  loanType: String
  rateInterval: String
  loanStatus: String
  loanStatusEnum: LoanStatus
  loanCurrency: String
  loanPurpose: String
  loanComputationRecord: AWSJSON
  loanAttribute1: String
  loanAttribute2: String
  numberOfPayments: Float
  paymentFrequency: String
  customFieldsData: AWSJSON
  status: String
  borrowerID: ID @index(name: "byBorrower", sortKeyFields: ["startDate"])
  borrower: Borrower @belongsTo(fields: ["borrowerID"])
  branchID: ID @index(name: "byBranch", sortKeyFields: ["startDate"])
  branch: Branch @belongsTo(fields: ["branchID"])
  payments: [Payment] @hasMany
  installments: [LoanInstallment] @hasMany
  disbursements: [LoanDisbursement] @hasMany
  events: [LoanEvent] @hasMany
  balanceSnapshots: [LoanBalanceSnapshot] @hasMany
  loanFees: [LoanFees] @hasMany
  penalties: [Penalty] @hasMany
  applications: [Application] @manyToMany(relationName: "LoanApplication")
  accounts: [Account] @manyToMany(relationName: "LoanAccount")
  guarantors: [Guarantor] @manyToMany(relationName: "LoanGuarantor")
  collateral: [Collateral] @manyToMany(relationName: "LoanCollateral")
  contracts: [Contract] @manyToMany(relationName: "LoanContract")
  expenses: [Expense] @manyToMany(relationName: "LoanExpense")
  documents: [Document] @manyToMany(relationName: "LoanDocument")
  moneyTransactions: [MoneyTransaction] @hasMany
  loanProductID: ID @index(name: "byLoanProductID")
  loanProduct: LoanProduct @belongsTo(fields: ["loanProductID"])
  createdByEmployeeID: ID @index(name: "byCreatedByEmployeeID")
  createdByEmployee: Employee @belongsTo(fields: ["createdByEmployeeID"])

  loanDraftID: ID @index(name: "byLoanDraftID")
  loanDraft: LoanDraft @belongsTo(fields: ["loanDraftID"])
  # --- Group Lending ---
  # If this is a group loan, link it to the Group
  groupID: ID @index(name: "byGroupLoan")
  group: Group @belongsTo(fields: ["groupID"])

  # --- Collections ---
  # If the loan is in default, it has a collection case file
  collectionCase: CollectionCase @hasOne

  # --- Accounting Traceability ---
  # Link to the Journal Entry that disbursed this loan
  relatedJournalEntries: [JournalEntry] @hasMany
}

type LoanInstallment @model {
  id: ID!
  loanID: ID! @index(name: "byLoan", sortKeyFields: ["dueDate"])
  loan: Loan @belongsTo(fields: ["loanID"])
  dueDate: AWSDate!
  principalDue: Float
  interestDue: Float
  feesDue: Float
  penaltyDue: Float
  totalDue: Float
  principalPaid: Float
  interestPaid: Float
  feesPaid: Float
  penaltyPaid: Float
  totalPaid: Float
  status: InstallmentStatus
  calculationRecord: AWSJSON
  events: [LoanEvent] @hasMany
  moneyTransactions: [MoneyTransaction] @hasMany
  payments: [Payment] @hasMany
}

type LoanDisbursement @model {
  id: ID!
  loanID: ID! @index(name: "byLoan", sortKeyFields: ["disbursedAt"])
  loan: Loan @belongsTo(fields: ["loanID"])
  disbursedAt: AWSDateTime!
  amount: Float!
  status: DisbursementStatus
  method: String
  reference: String
  accountID: ID @index(name: "byAccountID")
  account: Account @belongsTo(fields: ["accountID"])
  moneyTransactionID: ID @index(name: "byMoneyTransaction")
  moneyTransaction: MoneyTransaction @belongsTo(fields: ["moneyTransactionID"])
  moneyTransactions: [MoneyTransaction] @hasMany
  events: [LoanEvent] @hasMany
}

type LoanEvent @model {
  id: ID!
  loanID: ID! @index(name: "byLoan", sortKeyFields: ["eventAt"])
  loan: Loan @belongsTo(fields: ["loanID"])
  eventAt: AWSDateTime!
  eventType: LoanEventType!
  actorEmployeeID: ID
  summary: String
  payload: AWSJSON
  paymentID: ID @index(name: "byPayment")
  payment: Payment @belongsTo(fields: ["paymentID"])
  installmentID: ID @index(name: "byInstallment")
  installment: LoanInstallment @belongsTo(fields: ["installmentID"])
  disbursementID: ID @index(name: "byDisbursement")
  disbursement: LoanDisbursement @belongsTo(fields: ["disbursementID"])
}

type LoanBalanceSnapshot @model {
  id: ID!
  loanID: ID! @index(name: "byLoan", sortKeyFields: ["asOfAt"])
  loan: Loan @belongsTo(fields: ["loanID"])
  asOfAt: AWSDateTime!
  principalOutstanding: Float
  interestOutstanding: Float
  feesOutstanding: Float
  penaltyOutstanding: Float
  totalOutstanding: Float
  daysPastDue: Int
  snapshotRecord: AWSJSON
}

type Investment @model {
  id: ID!
  principal: Float
  description: String
  fees: Float
  interestRate: Float
  startDate: AWSDate
  maturityDate: AWSDate
  stopDate: AWSDate
  extensionPeriod: Float
  duration: Float
  durationInterval: String
  type: String
  rateInterval: String
  investmentStatus: String
  investmentAttribute1: String
  investmentAttribute2: String
  numberOfPayments: Float
  paymentFrequency: Float
  status: String
  accounts: [Account] @manyToMany(relationName: "InvestmentAccount")
}

type LoanFees @model {
  id: ID!
  amount: Float
  loanFeesName: String
  loanFeesCategory: String
  loanFeesCalculationMethod: String
  loanFeesRate: Float
  loanFeesDate: AWSDate
  loanFeesStatus: String
  notes: String
  loanFeesType: String
  loanFeesDescription: String
  loanFeesAttribute1: String
  loanFeesAttribute2: String
  status: String
  loan: Loan @belongsTo
  loanProducts: [LoanProduct] @manyToMany(relationName: "LoanProductLoanFees")
  accountID: ID @index(name: "byAccountID")
  account: Account @belongsTo(fields: ["accountID"])
  loanFeesConfigs: [LoanFeesConfig]
    @manyToMany(relationName: "LoanFeesLoanFeesConfig")
}

type Penalty @model {
  id: ID!
  amount: Float
  penaltyName: String
  penaltyCategory: String
  penaltyCalculationMethod: String
  penaltyRate: Float
  penaltyDate: AWSDate
  penaltyStatus: String
  notes: String
  penaltyType: String
  penaltyDescription: String
  penaltyAttribute1: String
  penaltyAttribute2: String
  status: String
  loan: Loan @belongsTo
  loanProducts: [LoanProduct] @manyToMany(relationName: "LoanProductPenalty")
  accountID: ID @index(name: "byAccountID")
  account: Account @belongsTo(fields: ["accountID"])
}

type Payroll @model {
  id: ID!
  periodStartDate: AWSDate
  periodEndDate: AWSDate
  payDate: AWSDate
  status: String
  processedByUserID: String
  totalGrossPay: Float
  totalLoanDeductions: Float
  totalSavingsDeductions: Float
  totalShareDeductions: Float
  totalNetPay: Float
  details: String
  branch: Branch @belongsTo
  employees: [Employee] @manyToMany(relationName: "PayrollEmployee")
}

type Account @model {
  id: ID!
  name: String
  accountType: String
  accountNumber: String
  description: String
  currency: String
  currentBalance: Float
  openingBalance: Float
  interestRate: Float
  interestCalculationMethod: String
  interestPostingFrequency: String
  interestPostingDate: String
  interestAccrued: Float
  interestAccruedDate: AWSDate
  accountStatus: String
  status: String
  institution: Institution @belongsTo
  branches: [Branch] @manyToMany(relationName: "AccountBranch")
  moneyTransactions: [MoneyTransaction] @hasMany
  expenses: [Expense] @hasMany
  loans: [Loan] @manyToMany(relationName: "LoanAccount")
  investments: [Investment] @manyToMany(relationName: "InvestmentAccount")
  otherIncomes: [OtherIncome] @manyToMany(relationName: "OtherIncomeAccount")
  loanFees: [LoanFees] @hasMany
  payments: [Payment] @hasMany
  disbursements: [LoanDisbursement] @hasMany
  penalties: [Penalty] @hasMany
  createdByEmployeeID: ID @index(name: "byCreatedByEmployeeID")
  createdByEmployee: Employee @belongsTo(fields: ["createdByEmployeeID"])
}

type MoneyTransaction @model {
  id: ID!
  transactionType: String
  transactionDate: AWSDate
  amount: Float!
  description: String
  referenceNumber: String
  relatedEntityType: String
  approvalStatus: String
  approvedDate: AWSDate
  category: String
  notes: String
  paymentMethod: String
  deviceInfo: String
  status: String
  account: Account @belongsTo
  loanID: ID @index(name: "byLoan", sortKeyFields: ["transactionDate"])
  loan: Loan @belongsTo(fields: ["loanID"])
  paymentID: ID @index(name: "byPayment")
  payment: Payment @belongsTo(fields: ["paymentID"])
  disbursementID: ID @index(name: "byDisbursement")
  disbursement: LoanDisbursement @belongsTo(fields: ["disbursementID"])
  installmentID: ID @index(name: "byInstallment")
  installment: LoanInstallment @belongsTo(fields: ["installmentID"])
  documents: [Document] @manyToMany(relationName: "MoneyTransactionDocument")
  createdByEmployeeID: ID @index(name: "byCreatedByEmployeeID")
  createdByEmployee: Employee @belongsTo(fields: ["createdByEmployeeID"])

  paymentsLink: [Payment] @hasMany
  disbursementsLink: [LoanDisbursement] @hasMany
}

type Payment @model {
  id: ID!
  paymentDate: AWSDate
  paymentType: String
  amount: Float!
  description: String
  referenceNumber: String
  paymentMethod: String
  status: String
  paymentStatusEnum: PaymentStatus
  notes: String
  loanID: ID @index(name: "byLoan", sortKeyFields: ["paymentDate"])
  loan: Loan @belongsTo(fields: ["loanID"])
  installmentID: ID @index(name: "byInstallment")
  installment: LoanInstallment @belongsTo(fields: ["installmentID"])
  moneyTransactionID: ID @index(name: "byMoneyTransaction")
  moneyTransaction: MoneyTransaction @belongsTo(fields: ["moneyTransactionID"])
  accountID: ID @index(name: "byAccountID")
  account: Account @belongsTo(fields: ["accountID"])
  receivingEmployeeID: ID @index(name: "byReceivingEmployeeID")
  receivingEmployee: Employee @belongsTo(fields: ["receivingEmployeeID"])
  documents: [Document] @manyToMany(relationName: "PaymentDocument")
  moneyTransactions: [MoneyTransaction] @hasMany
  events: [LoanEvent] @hasMany
  amountAllocatedToPrincipal: Float
  amountAllocatedToInterest: Float
  amountAllocatedToFees: Float
  amountAllocatedToPenalty: Float
  # --- Accounting Traceability ---
  # Link to the Journal Entry that recorded this payment
  relatedJournalEntries: [JournalEntry] @hasMany
}

type Expense @model {
  id: ID!
  transactionDate: AWSDate
  amount: Float!
  description: String
  referenceNumber: String
  receiptDocumentS3Key: String
  status: String
  notes: String
  payee: String
  paymentMethod: String
  checkNumber: String
  approvedDate: AWSDate
  type: String
  category: String
  account: Account @belongsTo
  loans: [Loan] @manyToMany(relationName: "LoanExpense")
  applications: [Application] @manyToMany(relationName: "ApplicationExpense")
  documents: [Document] @manyToMany(relationName: "ExpenseDocument")
  createdByEmployeeID: ID @index(name: "byCreatedByEmployeeID")
  createdByEmployee: Employee @belongsTo(fields: ["createdByEmployeeID"])
  # --- Accounting Traceability ---
  relatedJournalEntries: [JournalEntry] @hasMany
}

type OtherIncome @model {
  id: ID!
  name: String
  description: String
  amount: Float
  incomeDate: AWSDate
  incomeType: String
  status: String
  accounts: [Account] @manyToMany(relationName: "OtherIncomeAccount")
}

type FinancialReport @model {
  id: ID!
  reportName: String
  reportType: String
  reportDate: AWSDate
  startDate: AWSDate
  endDate: AWSDate
  reportData: AWSJSON
  status: String
  branch: Branch @belongsTo
}

type CustomFormField @model {
  id: ID!
  formKey: String # e.g. "CreateBorrowerForm"
  label: String
  fieldType: String # e.g. "text", "number", "select"
  options: AWSJSON # for dropdowns, radios, etc.
  required: Boolean
  order: Int
  createdBy: String
  status: String
  branch: Branch @belongsTo
  institution: Institution @belongsTo
}

type LoanFeesConfig @model {
  id: ID!
  name: String # Fee name (required)
  category: String # "non_deductable", "deductable", or "capitalized"
  calculationMethod: String # "fixed" or "percentage"
  description: String
  percentageBase: String # "principal", "interest", or "principal_interest" (nullable, only for percentage)
  rate: Float # For percentage-based fees (nullable)
  status: String
  institution: Institution @belongsTo
  branches: [Branch] @manyToMany(relationName: "BranchLoanFeesConfig")
  loanFees: [LoanFees] @manyToMany(relationName: "LoanFeesLoanFeesConfig")
  loanProducts: [LoanProduct]
    @manyToMany(relationName: "LoanProductLoanFeesConfig")
}

type Message @model {
  id: ID!
  subject: String
  body: String
  status: String
  createdAt: AWSDateTime
  sender: User @belongsTo(fields: ["senderUserId"])
  senderUserId: ID! @index(name: "bySender")
  recipient: User @belongsTo(fields: ["recipientUserId"])
  recipientUserId: ID! @index(name: "byRecipient")
}

type Notification @model {
  id: ID!
  subject: String
  body: String
  notificationType: String # e.g., "USER_JOIN_REQUEST", "BORROWER_EDIT_APPROVAL"
  approvalStatus: String # e.g., "PENDING", "APPROVED", "REJECTED"
  referenceId: String # ID of the entity being approved/notified about (e.g., userID, borrowerID)
  status: String # "unread", "read"
  createdAt: AWSDateTime
  sender: User @belongsTo(fields: ["senderUserId"])
  senderUserId: ID! @index(name: "bySender")
  recipient: User @belongsTo(fields: ["recipientUserId"])
  recipientUserId: ID! @index(name: "byRecipient")
  institutionMessagesId: ID @index(name: "byInstitution")
}

type Group @model {
  id: ID!
  name: String
  groupNumber: String
  formationDate: AWSDate
  meetingDay: String # e.g., "Tuesday"
  meetingFrequency: String # e.g., "Weekly"
  # Leadership
  chairpersonID: String
  secretaryID: String
  viceChairpersonID: String
  treasurerID: String

  status: String # Active, Dissolved
  # Relationships
  branch: Branch @belongsTo
  members: [Borrower] @hasMany
  loans: [Loan] @hasMany
  groupSavingsAccount: SavingsAccount @hasOne # Groups often save collectively
}

# Defines the product (e.g., "Christmas Savings", "Ordinary Shares")
type SavingsProduct @model {
  id: ID!
  name: String
  type: String # "Voluntary", "Compulsory", "FixedDeposit"
  interestRate: Float
  interestPostingFrequency: String # "Monthly", "Annually"
  minBalance: Float
  institution: Institution @belongsTo
  savingsAccounts: [SavingsAccount] @hasMany
}

# The actual account held by a member
type SavingsAccount @model {
  id: ID!
  accountNumber: String
  balance: Float
  status: String # Active, Dormant, Frozen
  # Relationships
  borrower: Borrower @belongsTo
  savingsProduct: SavingsProduct @belongsTo

  # For Locking savings against a loan (Self-guarantee)
  lockedAmount: Float
  lockedForLoanID: ID

  transactions: [SavingsTransaction] @hasMany
}

type SavingsTransaction @model {
  id: ID!
  amount: Float
  type: String # Deposit, Withdrawal, Interest, Fee
  date: AWSDateTime
  savingsAccount: SavingsAccount @belongsTo
  initiatedBy: Employee @belongsTo
}

# Share Capital Management
type ShareAccount @model {
  id: ID!
  numberOfShares: Float
  shareValue: Float # Current value per share
  totalValue: Float

  borrower: Borrower @belongsTo
  transactions: [ShareTransaction] @hasMany
}

type ShareTransaction @model {
  id: ID!
  type: String # Purchase, Transfer, Dividend
  numberOfShares: Float
  amount: Float
  date: AWSDateTime
  shareAccount: ShareAccount @belongsTo
}

type ChartOfAccounts @model {
  id: ID!
  code: String! # e.g., "1000"
  name: String! # e.g., "Cash at Hand"
  type: String! # Asset, Liability, Equity, Income, Expense
  subtype: String # e.g., "Current Asset"
  balance: Float
  institution: Institution @belongsTo

  journalLines: [JournalLine] @hasMany
}

type JournalEntry @model {
  id: ID!
  date: AWSDate
  description: String
  reference: String
  postedBy: Employee @belongsTo
  status: String # Draft, Posted
  # The double-entry lines
  lines: [JournalLine] @hasMany

  # Link to operational events for audit trail
  relatedLoanID: ID
  relatedPaymentID: ID
  relatedExpenseID: ID
}

type JournalLine @model {
  id: ID!
  journalEntry: JournalEntry @belongsTo
  chartOfAccounts: ChartOfAccounts @belongsTo
  debit: Float
  credit: Float
  description: String
}
type Meeting @model {
  id: ID!
  title: String # e.g., "2025 AGM"
  date: AWSDateTime
  type: String # AGM, Board, Committee
  status: String
  minutes: String
  # Attendance stored as JSON array of { borrowerID, isPresent, notes }
  attendanceRecord: AWSJSON
  # Resolutions stored as JSON array of { title, description, votesFor, votesAgainst, status }
  resolutionsRecord: AWSJSON
}

type DividendDeclaration @model {
  id: ID!
  fiscalYear: Int
  distributableSurplus: Float
  dividendRate: Float # Percentage on Shares
  interestRebateRate: Float # Percentage on Interest Paid (Patronage)
  status: String # Draft, Approved, Distributed
  institution: Institution @belongsTo
}

type Approval @model {
  id: ID!
  approvalType: ApprovalType!
  recordID: ID! # ID of the record being approved (loan, expense, application, etc.)
  approvalDate: AWSDate
  status: String # Pending, Approved, Rejected
  notes: String
  employee: Employee @belongsTo
}

type CollectionCase @model {
  id: ID!
  loanID: ID! @index(name: "byLoanCollection")
  loan: Loan @belongsTo(fields: ["loanID"])

  assignedToEmployeeID: ID @index(name: "byAssignedEmployee")
  assignedTo: Employee @belongsTo(fields: ["assignedToEmployeeID"])

  stage: String # "Soft", "Hard", "Legal", "WriteOff"
  status: String # Open, Resolved
}

# ---------- End of Schema ----------
